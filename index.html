<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowra - 設計書作成ツール</title>
    <style>
        :root {
            --primary-bg: #f4f7fc;
            --sidebar-bg: #ffffff;
            --header-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --accent-color: #4285f4;
            --hover-bg: #e8f0fe;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px var(--shadow-color);
        }

        .sidebar-header {
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-menu {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .menu-section h3 {
            padding: 10px 20px;
            margin: 0;
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            font-weight: bold;
        }

        .menu-item {
            display: block;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--text-color);
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            background-color: var(--hover-bg);
            border-left-color: var(--accent-color);
        }

        .menu-item.active {
            background-color: var(--hover-bg);
            border-left-color: var(--accent-color);
            font-weight: 500;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .mode-switch {
            display: flex;
            align-items: center;
        }

        .mode-switch label {
            margin-right: 10px;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .actions button {
            padding: 10px 15px;
            margin-left: 10px;
            border: 1px solid var(--border-color);
            background-color: #fff;
            color: var(--accent-color);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .actions button:hover {
            background-color: var(--accent-color);
            color: #fff;
        }

        .canvas {
            flex-grow: 1;
            padding: 20px;
            background-color: #e9eef6;
            overflow: auto;
            position: relative;
        }
        
        .canvas-title {
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #333;
        }

        .diagram-element {
            position: absolute;
            background-color: #fff;
            border: 1px solid #999;
            padding: 10px;
            cursor: move;
            box-shadow: 3px 3px 7px rgba(0,0,0,0.15);
            border-radius: 4px;
            text-align: center;
            font-size: 0.9em;
        }

        .process {
            border-radius: 50%;
            width: 80px; /* Adjusted for a perfect circle */
            height: 80px; /* Adjusted for a perfect circle */
            display: flex; /* To center text vertically */
            align-items: center; /* To center text vertically */
            justify-content: center; /* To center text horizontally */
        }

        .entity {
            border-radius: 8px;
            background-color: #fff8e1;
            width: 120px;
        }

        .datastore {
            border-left: none;
            border-right: none;
            border-top: 1px solid #999;
            border-bottom: 1px solid #999;
            width: 140px;
            background-color: #e3f2fd;
        }
        
        /* 簡易的な矢印 */
        .data-flow {
            position: absolute;
            width: 100px;
            height: 2px;
            background-color: #333;
            transform-origin: 0 50%;
        }
        .data-flow::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -4px;
            border-style: solid;
            border-width: 5px 0 5px 8px;
            border-color: transparent transparent transparent #333;
        }


        .sidebar-menu .menu-item-button {
            display: block;
            width: calc(100% - 40px);
            margin: 5px 20px;
            padding: 10px;
            font-size: 0.9em;
            text-align: left;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-menu .menu-item-button:hover {
            background-color: var(--hover-bg);
            border-color: var(--accent-color);
        }
        .canvas.drawing-mode {
            cursor: crosshair;
        }

        .sidebar-menu .menu-item-button:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
            color: #999;
        }

        .context-menu {
            display: none;
            position: absolute;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px var(--shadow-color);
            border-radius: 5px;
            padding: 5px 0;
            z-index: 1000;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .context-menu-item:hover {
            background-color: var(--hover-bg);
        }

    </style>
</head>
<body>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">Flowra</div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <h3>DFD</h3>
                    <button id="add-process" class="menu-item-button">プロセス追加</button>
                    <button id="add-datastore" class="menu-item-button">データストア追加</button>
                    <button id="add-entity" class="menu-item-button">外部エンティティ追加</button>
                    <button id="add-dataflow" class="menu-item-button">データフロー追加</button>
                </div>
                <div class="menu-section">
                    <h3>ER</h3>
                    <a href="#" class="menu-item">ER</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="mode-switch">
                    <label for="mode">閲覧モード</label>
                    <label class="switch">
                        <input type="checkbox" id="mode">
                        <span class="slider"></span>
                    </label>
                    <label for="mode">編集モード</label>
                </div>
                <div class="actions">
                    <button>インポート</button>
                    <button id="export-btn">エクスポート</button>
                </div>
            </header>
            <div class="canvas">
                <h2 class="canvas-title">DFD: ○○システム</h2>

                <!-- サンプル図形 -->
                <div id="e01" class="diagram-element entity" style="top: 100px; left: 50px;">
                    <span>e01: 管理者</span>
                </div>
                <div id="p0" class="diagram-element process" style="top: 100px; left: 300px;">
                    <span>p0: ○○システム</span>
                </div>
                <div id="s01" class="diagram-element datastore" style="top: 300px; left: 300px;">
                    <span>s01: □□テーブル</span>
                </div>
                 <div id="e02" class="diagram-element entity" style="top: 250px; left: 50px;">
                    <span>e02: ユーザー</span>
                </div>

                <!-- サンプル矢印 (管理者 -> ○○システム) -->
                <div id="flow1" class="data-flow" data-from="e01" data-to="p0"></div>
                
            </div>
        </main>
    </div>

    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="edit-label">ラベル編集</div>
        <div class="context-menu-item" id="edit-note">ノート編集</div>
        <div style="border-top: 1px solid var(--border-color); margin: 5px 0;"></div>
        <div class="context-menu-item" id="delete-shape">図形の削除</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.querySelector('.canvas');
            const exportBtn = document.getElementById('export-btn');
            const addProcessBtn = document.getElementById('add-process');
            const addDatastoreBtn = document.getElementById('add-datastore');
            const addEntityBtn = document.getElementById('add-entity');
            const addDataflowBtn = document.getElementById('add-dataflow');
            const contextMenu = document.getElementById('context-menu');
            const editLabelBtn = document.getElementById('edit-label');
            const deleteShapeBtn = document.getElementById('delete-shape');
            const modeSwitch = document.getElementById('mode');
            
            let activeElement = null;
            let contextTarget = null;
            let offsetX = 0;
            let offsetY = 0;
            let shapeCounters = { process: 1, datastore: 1, entity: 2, flow: 2 };
            let currentMode = 'normal'; // normal, drawing-flow-start, drawing-flow-end
            let flowStartElement = null;

            const isEditMode = () => modeSwitch.checked;

            function updateEditorControls() {
                const editModeActive = isEditMode();
                addProcessBtn.disabled = !editModeActive;
                addDatastoreBtn.disabled = !editModeActive;
                addEntityBtn.disabled = !editModeActive;
                addDataflowBtn.disabled = !editModeActive;

                if (!editModeActive) {
                    setMode('normal');
                }
            }

            function setMode(mode) {
                currentMode = mode;
                if (mode === 'drawing-flow-start' || mode === 'drawing-flow-end') {
                    canvas.classList.add('drawing-mode');
                } else {
                    canvas.classList.remove('drawing-mode');
                    flowStartElement = null;
                }
            }

            function addShape(type, label) {
                const newShape = document.createElement('div');
                const typeName = type.split('-').pop();
                const newId = `${typeName.charAt(0)}${shapeCounters[typeName]++}`;
                newShape.id = newId;
                newShape.classList.add('diagram-element', typeName);
                newShape.style.top = '20px';
                newShape.style.left = '20px';
                const span = document.createElement('span');
                span.textContent = `${newId}: ${label}`;
                newShape.appendChild(span);
                canvas.appendChild(newShape);
            }

            function addDataFlow(fromEl, toEl) {
                const newFlow = document.createElement('div');
                const newId = `flow${shapeCounters.flow++}`;
                newFlow.id = newId;
                newFlow.classList.add('data-flow');
                newFlow.dataset.from = fromEl.id;
                newFlow.dataset.to = toEl.id;
                canvas.appendChild(newFlow);
                updateArrows();
            }

            function getIntersectionPoint(rect, otherCenter) {
                const center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
                const dx = otherCenter.x - center.x;
                const dy = otherCenter.y - center.y;
                const halfW = rect.width / 2;
                const halfH = rect.height / 2;
                if (dx === 0) return { x: center.x, y: center.y + Math.sign(dy) * halfH };
                if (dy === 0) return { x: center.x + Math.sign(dx) * halfW, y: center.y };
                const slope = dy / dx;
                const rectSlope = halfH / halfW;
                let x, y;
                if (Math.abs(slope) < rectSlope) {
                    x = center.x + Math.sign(dx) * halfW;
                    y = center.y + slope * (x - center.x);
                } else {
                    y = center.y + Math.sign(dy) * halfH;
                    x = center.x + (y - center.y) / slope;
                }
                return { x, y };
            }

            function updateArrows() {
                const flows = document.querySelectorAll('.data-flow');
                flows.forEach(flow => {
                    const fromElement = document.getElementById(flow.dataset.from);
                    const toElement = document.getElementById(flow.dataset.to);
                    if (fromElement && toElement) {
                        const fromRect = fromElement.getBoundingClientRect();
                        const toRect = toElement.getBoundingClientRect();
                        const canvasRect = canvas.getBoundingClientRect();
                        const fromCenter = { x: fromRect.left + fromRect.width / 2, y: fromRect.top + fromRect.height / 2 };
                        const toCenter = { x: toRect.left + toRect.width / 2, y: toRect.top + toRect.height / 2 };
                        const startPoint = getIntersectionPoint(fromRect, toCenter);
                        const endPoint = getIntersectionPoint(toRect, fromCenter);
                        const x1 = startPoint.x - canvasRect.left;
                        const y1 = startPoint.y - canvasRect.top;
                        const x2 = endPoint.x - canvasRect.left;
                        const y2 = endPoint.y - canvasRect.top;
                        const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                        const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);
                        flow.style.width = `${length}px`;
                        flow.style.left = `${x1}px`;
                        flow.style.top = `${y1}px`;
                        flow.style.transform = `rotate(${angle}deg)`;
                    }
                });
            }

            function onMouseDown(e) {
                if (e.button !== 0) return;
                const target = e.target.closest('.diagram-element');

                if (currentMode === 'drawing-flow-start' && target) {
                    flowStartElement = target;
                    setMode('drawing-flow-end');
                    return;
                }

                if (currentMode === 'drawing-flow-end' && target && target !== flowStartElement) {
                    addDataFlow(flowStartElement, target);
                    setMode('normal');
                    return;
                }

                if (currentMode === 'normal' && target) {
                    e.preventDefault();
                    activeElement = target;
                    offsetX = activeElement.offsetWidth / 2;
                    offsetY = activeElement.offsetHeight / 2;
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                }
            }

            function onMouseMove(e) {
                if (!activeElement) return;
                e.preventDefault();
                const canvasRect = canvas.getBoundingClientRect();
                let x = e.clientX - offsetX - canvasRect.left;
                let y = e.clientY - offsetY - canvasRect.top;
                x = Math.max(0, Math.min(x, canvas.clientWidth - activeElement.offsetWidth));
                y = Math.max(0, Math.min(y, canvas.clientHeight - activeElement.offsetHeight));
                activeElement.style.left = `${x}px`;
                activeElement.style.top = `${y}px`;
                updateArrows();
            }

            function onMouseUp(e) {
                if (!activeElement) return;
                e.preventDefault();
                activeElement = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            function handleExport() {
                const exportData = { context: { description: "○○システムについて", "root-process": {}, "external-entity": [], "data-store": [], "data-flow": [] } };
                document.querySelectorAll('.diagram-element').forEach(el => {
                    const item = { id: el.id, label: el.querySelector('span').textContent || '', description: "" };
                    if (el.classList.contains('process')) {
                        if (!exportData.context.process) exportData.context.process = [];
                        exportData.context.process.push(item);
                    } else if (el.classList.contains('entity')) {
                        exportData.context['external-entity'].push(item);
                    }
                });
                document.querySelectorAll('.data-flow').forEach(el => {
                    exportData.context['data-flow'].push({ from: el.dataset.from, to: [el.dataset.to], label: "", description: "" });
                });
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'flowra-export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function showContextMenu(e) {
                if (!isEditMode()) return;
                e.preventDefault();
                if (currentMode !== 'normal') return;
                contextTarget = e.target.closest('.diagram-element');
                if (contextTarget) {
                    contextMenu.style.top = `${e.clientY}px`;
                    contextMenu.style.left = `${e.clientX}px`;
                    contextMenu.style.display = 'block';
                } else {
                    hideContextMenu();
                }
            }

            function hideContextMenu() {
                contextMenu.style.display = 'none';
                contextTarget = null;
            }

            function handleEditLabel() {
                if (!contextTarget) return;
                const span = contextTarget.querySelector('span');
                if (!span) return;
                const oldLabel = span.textContent;
                const parts = oldLabel.split(/:(.*)/s);
                const idPart = parts[0];
                const textPart = parts[1] ? parts[1].trim() : '';
                const newText = prompt('新しいラベルを入力してください:', textPart);
                if (newText !== null) {
                    span.textContent = `${idPart}: ${newText.trim()}`;
                }
                hideContextMenu();
            }

            function handleDeleteShape() {
                if (!contextTarget) return;
                const shapeId = contextTarget.id;
                const flows = document.querySelectorAll(`.data-flow[data-from="${shapeId}"], .data-flow[data-to="${shapeId}"]`);
                flows.forEach(flow => flow.remove());
                contextTarget.remove();
                hideContextMenu();
            }

            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('contextmenu', showContextMenu);
            window.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    setMode('normal');
                }
            });

            exportBtn.addEventListener('click', handleExport);
            addProcessBtn.addEventListener('click', () => addShape('process', '新規プロセス'));
            addDatastoreBtn.addEventListener('click', () => addShape('datastore', '新規データストア'));
            addEntityBtn.addEventListener('click', () => addShape('entity', '新規エンティティ'));
            addDataflowBtn.addEventListener('click', () => {
                if (isEditMode()) {
                    setMode(currentMode === 'normal' ? 'drawing-flow-start' : 'normal');
                }
            });
            editLabelBtn.addEventListener('click', handleEditLabel);
            deleteShapeBtn.addEventListener('click', handleDeleteShape);
            modeSwitch.addEventListener('change', updateEditorControls);
            
            updateArrows();
            updateEditorControls(); // Set initial state
        });
    </script>
</body>
</html>
